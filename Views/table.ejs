<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Телефонный справочник</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f0f2f5;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      padding: 1rem 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .navbar-brand {
      color: white !important;
      font-size: 1.4rem;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .navbar .text-secondary {
      color: rgba(255,255,255,0.9) !important;
    }

    .navbar .btn-outline-secondary {
      color: white;
      border-color: rgba(255,255,255,0.5);
      transition: all 0.3s ease;
    }

    .navbar .btn-outline-secondary:hover {
      background: rgba(255,255,255,0.2);
      border-color: white;
      color: white;
      transform: translateY(-1px);
    }

    #filterBtn, #addBtn {
      border: none;
      padding: 10px 20px;
      font-weight: 500;
      border-radius: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #filterBtn {
      background: #4a90e2;
      color: white;
    }

    #filterBtn:hover {
      background: #357abd;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74,144,226,0.4);
    }

    #addBtn {
      background: #48bb78;
      color: white;
    }

    #addBtn:hover {
      background: #38a169;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(72,187,120,0.4);
    }

    /* --- ИЗМЕНЕНИЕ ЗДЕСЬ --- */
    #tableContainer {
      /* Свойства max-width и margin убраны, т.к. они теперь у родительской обёртки */
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 30px;
      animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .table {
      margin-bottom: 0;
      border: none;
      border-radius: 12px;
      overflow: hidden;
    }

    .table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .table th {
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      padding: 15px;
      border: none;
    }

    #tableContainer th {
      background: transparent;
    }

    .table td {
      padding: 12px;
      border-color: #e9ecef;
      font-size: 0.95rem;
      color: #495057;
    }

    .table tbody tr {
      transition: all 0.2s ease;
    }

    .table tbody tr:hover {
      background-color: #f8f9fa;
      transform: scale(1.01);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    td[contenteditable="true"] {
      background: #e3f2fd;
      position: relative;
      cursor: text;
      transition: all 0.3s ease;
    }

    td[contenteditable="true"]:hover {
      background: #bbdefb;
      box-shadow: inset 0 0 0 2px #2196f3;
    }

    td[contenteditable="true"]:focus {
      background: white;
      outline: none;
      box-shadow: inset 0 0 0 2px #667eea;
    }

    .table input[type="text"] {
      border: 2px solid #e9ecef;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .table input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px  rgba(102,126,234,0.1);
    }

    #tableContainer .table thead th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: #fff !important;
      border: none !important;
    }

    #tableContainer .table input.form-control:focus {
      border-color: #667eea !important;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
    }

    #tableContainer .table input.form-control {
      background: #fff;
      border: 2px solid #bfc7d3 !important;
      border-radius: 8px;
      color: #1f2937;
      outline: none;
      box-shadow: none;
    }

    #tableContainer .table input.form-control::placeholder {
      color: #6b7280;
    }

    #modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }

    #modal > div {
      background: white;
      padding: 35px;
      border-radius: 16px;
      min-width: 400px;
      max-width: 500px;
      position: relative;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from {
        transform: translateY(-30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    #closeModal {
      position: absolute;
      right: 20px;
      top: 20px;
      width: 32px;
      height: 32px;
      cursor: pointer;
      color: #999;
      font-size: 24px;
      line-height: 32px;
      text-align: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    #closeModal:hover {
      background: #f5f5f5;
      color: #333;
      transform: rotate(90deg);
    }

    #addForm label {
      display: block;
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
      font-size: 0.97rem;
    }

    #addForm input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #656769;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    #addForm input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    #addForm button {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    #addForm button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(72,187,120,0.4);
    }

    @media (max-width: 768px) {
      .navbar-brand {
        font-size: 1.1rem;
      }
      
      .navbar .text-secondary {
        display: none;
      }
      
      #tableContainer {
        padding: 15px;
        border-radius: 12px;
      }
      
      .table {
        font-size: 0.85rem;
      }
      
      .table th, .table td {
        padding: 8px 5px;
      }
      
      #modal > div {
        min-width: 90vw;
        padding: 25px;
      }
    }

    .container {
      animation: fadeIn 0.5s ease-out;
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
    <div class="container">
      <span class="navbar-brand fw-bold">Телефонный справочник</span>
      <div class="d-flex align-items-center">
        <span class="me-3 text-secondary">Пользователь: <%= user.username %> (<%= user.role %>)</span>
        <a href="/logout" class="btn btn-outline-secondary btn-sm">Выйти</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div style="max-width: 1200px; margin: 0 auto;">

      <div class="d-flex justify-content-end mb-3">
        <button id="filterBtn" class="btn btn-primary btn-sm me-2">Фильтр</button>
        <% if (user.role === 'admin') { %>
          <button id="addBtn" class="btn btn-success btn-sm">Добавить запись</button>
        <% } %>
      </div>

      <% if (user.role === 'admin') { %>
        <div id="modal" style="display: none;">
          <div>
            <span id="closeModal">&times;</span>
            <form id="addForm">
              <% for(let key in rows[0]) { if(key !== 'id') { %>
                <div class="mb-2">
                  <%if (key == "role") key = "Роль"%>
                  <%if (key == "department") key = "Отдел"%>
                  <%if (key == "phonenumber") key = "Номер телефона"%>
                  <label class="form-label"><%= key %></label>
                  <input name="<%= key %>" class="form-control" required>
                </div>
              <% } } %>
              <button type="submit" class="btn btn-success w-100">Сохранить</button>
            </form>
          </div>
        </div>
      <% } %>

      <div id="tableContainer">
        <table class="table table-bordered table-hover align-middle shadow-sm">
          <thead>
            <tr>
              <% for(let key in rows[0]) { %>
                <%if (key == "role") key = "роль"%>
                <%if (key == "id") key = "код"%>
                <%if (key == "department") key = "отделение"%>
                <%if (key == "phonenumber") key = "номер телефона"%>
                <th><%= key %></th>
              <% } %>
            </tr>
          </thead>
          <tbody>
            <% rows.forEach(row => { %>
              <tr>
                <% for(let key in row) { %>
                  <td 
                    contenteditable="<%= user.role === 'admin' && key !== 'id' %>" 
                    data-id="<%= row.id %>" 
                    data-key="<%= key %>">
                    <%= row[key] %>
                  </td>
                <% } %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <script>
    const USER_ROLE = "<%= user.role %>";
    const filterBtn = document.getElementById('filterBtn');
    let filterActive = false;
    let originalTableHTML;

    document.addEventListener('DOMContentLoaded', () => {
        originalTableHTML = document.querySelector('#tableContainer table').outerHTML;
    });

    filterBtn.addEventListener('click', function() {
      const table = document.querySelector('#tableContainer table');
      if (!filterActive) {
        originalTableHTML = table.outerHTML;
        const headerRow = table.rows[0];
        const filterRow = table.tHead.insertRow(1);
        for (let i = 0; i < headerRow.cells.length; i++) {
          const cell = filterRow.insertCell(i);
          cell.style.padding = '8px';
          cell.innerHTML = '<input type="text" class="form-control form-control-sm" placeholder="Поиск..." data-col="' + i + '">';
        }
        filterRow.querySelectorAll('input').forEach(input => {
          input.addEventListener('keyup', function() {
            const filters = Array.from(filterRow.querySelectorAll('input')).map(inp => inp.value.toLowerCase());
            const tableBody = table.querySelector('tbody');
            for (let r = 0; r < tableBody.rows.length; r++) {
              let show = true;
              for (let c = 0; c < filters.length; c++) {
                const cellText = tableBody.rows[r].cells[c].textContent.toLowerCase();
                if (filters[c] && !cellText.includes(filters[c])) {
                  show = false;
                  break;
                }
              }
              tableBody.rows[r].style.display = show ? '' : 'none';
            }
          });
        });
        filterActive = true;
        filterBtn.textContent = 'Сбросить';
        filterBtn.classList.remove('btn-primary');
        filterBtn.classList.add('btn-secondary');
      } else {
        table.outerHTML = originalTableHTML;
        filterActive = false;
        filterBtn.textContent = 'Фильтр';
        filterBtn.classList.remove('btn-secondary');
        filterBtn.classList.add('btn-primary');
      }
    });

    if (USER_ROLE === 'admin') {
      const modal = document.getElementById('modal');
      const addBtn = document.getElementById('addBtn');
      const closeModal = document.getElementById('closeModal');
      
      modal.style.display = 'none';
      
      addBtn.onclick = () => {
        modal.style.display = 'flex';
        modal.classList.add('show');
      };
      closeModal.onclick = () => {
        modal.style.display = 'none';
        modal.classList.remove('show');
      };
      window.onclick = (e) => { 
        if(e.target === modal) {
          modal.style.display = 'none';
          modal.classList.remove('show');
        }
      };

      document.getElementById('addForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {};
        formData.forEach((v, k) => data[k] = v);
        const res = await fetch('/add', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        if(res.ok) location.reload();
        else alert('Ошибка добавления');
      }

      document.getElementById('tableContainer').addEventListener('keydown', function(e) {
        if (e.target.tagName === 'TD' && e.target.isContentEditable && e.key === 'Enter') {
          e.preventDefault();
          e.target.blur();
        }
      });

      document.getElementById('tableContainer').addEventListener('blur', async function(e) {
        if (e.target.tagName === 'TD' && e.target.isContentEditable) {
            const td = e.target;
            const id = td.dataset.id;
            const key = td.dataset.key;
            let value = td.innerText.replace(/\s+/g, ' ').trim();
            const res = await fetch('/edit', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ id, key, value })
            });
            if(!res.ok) alert('Ошибка сохранения');
        }
      }, true);
    }
  </script>
</body>
</html>